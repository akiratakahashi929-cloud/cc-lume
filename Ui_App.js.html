<script>
  /* ============================================================
     CC Lume â€” Ui_App.js
     ãƒ•ãƒ­ãƒ³ãƒˆJSï¼ˆå…¨ç”»é¢åˆ¶å¾¡ãƒ»APIé€šä¿¡ãƒ»ç©´åŸ‹ã‚ãƒ»ãƒªãƒ—ãƒ©ã‚¤ãƒ»ã‚³ãƒ”ãƒ¼ãƒ»ãƒ’ãƒ³ãƒˆï¼‰
     ============================================================ */

  // === ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ===
  var APP = {
    token: null,
    lotNumber: null,
    currentScreen: 'login',
    strategy: null,
    strategyColor: null,
    posts: null,
    replyCount: 0,
    templateData: null,
    shareKey: '', // è¿½åŠ 
    // Vercelãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®GASãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰URL
    gasUrl: 'https://script.google.com/macros/s/AKfycbyARAuxDvgIRAH3-K9peyYTO0kdMuccij2Udkld46plyrOAeFqpFv00MfBF6GsAwnq6/exec'
  };

  /**
   * APIå‘¼ã³å‡ºã—ã®çµ±åˆãƒ©ãƒƒãƒ‘ãƒ¼
   * GASç’°å¢ƒãªã‚‰ google.script.runã€Vercelç­‰ãªã‚‰ fetch (/api/proxy) ã‚’ä½¿ç”¨
   */
  async function callApi(action, payload) {
    return new Promise((resolve, reject) => {
      // GASç’°å¢ƒåˆ¤å®š
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
        [action].apply(google.script.run, payload);
      } else {
        // Vercelç’°å¢ƒ: è‡ªå‰ã®APIãƒ—ãƒ­ã‚­ã‚·ã‚’çµŒç”±ã—ã¦GASã‚’å©ã
        console.log('--- callApi (fetch) START ---', action);
        fetch('/api/proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action, payload: payload })
        })
          .then(res => {
            console.log('--- callApi (fetch) Status ---', res.status);
            return res.json();
          })
          .then(data => {
            console.log('--- callApi (fetch) SUCCESS ---', action, data.success);
            resolve(data);
          })
          .catch(err => {
            console.error('--- callApi (fetch) ERROR ---', action, err);
            reject(err);
          });
      }
    });
  }

  // ============================================================
  // ç”»é¢é·ç§»
  // ============================================================
  function navigateTo(screen) {
    // === Version 1.0 å¯¸æ–­ã‚¬ãƒ¼ãƒ‰ ===
    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ã¤Coming SoonãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¹ãçŠ¶æ…‹ãªã‚‰ã€ä»–ç”»é¢ã¸ã®é·ç§»ã‚’é˜»æ­¢
    if (APP.token && screen !== 'login' && screen !== 'present' && screen !== 'comingSoon') {
      screen = 'comingSoon';
    }

    // å…¨ç”»é¢éè¡¨ç¤º
    document.querySelectorAll('.screen').forEach(function (s) { s.classList.remove('active'); });

    var screenMap = {
      'login': 'screenLogin',
      'present': 'screenPresent',
      'comingSoon': 'screenComingSoon',
      'dashboard': 'screenDashboard',
      'studio': 'screenStudio',
      'dictionary': 'screenDictionary',
      'growth': 'screenGrowth'
    };

    var el = document.getElementById(screenMap[screen]);
    if (el) el.classList.add('active');
    APP.currentScreen = screen;

    // ãƒŠãƒ“ãƒãƒ¼è¡¨ç¤ºåˆ¶å¾¡
    var nav = document.getElementById('navBar');
    if (screen === 'login' || screen === 'present' || screen === 'comingSoon') {
      nav.classList.add('hidden'); // Coming Soonã§ã‚‚éš ã™
    } else {
      nav.classList.remove('hidden');
    }

    // ãƒŠãƒ“ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
    document.querySelectorAll('.nav-item').forEach(function (ni) {
      ni.classList.toggle('active', ni.dataset.screen === screen);
    });

    // ç”»é¢ã”ã¨ã®åˆæœŸåŒ–
    if (screen === 'dashboard') loadDashboard();
    if (screen === 'studio') loadStudio();
    if (screen === 'dictionary') loadDictionary();
    if (screen === 'growth') loadGrowth();
    if (screen === 'present') loadPresent();

    window.scrollTo(0, 0);
  }

  // ============================================================
  // ãƒ­ã‚°ã‚¤ãƒ³
  // ============================================================
  function handleLogin() {
    var shareKey = document.getElementById('loginShareKey').value.trim();
    var gmail = document.getElementById('loginGmail').value.trim();
    var password = document.getElementById('loginPassword').value.trim();

    if (!shareKey || !gmail || !password) {
      showToast('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }

    showLoading('ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
    document.getElementById('btnLogin').disabled = true;

    callApi('apiLogin', { shareKey: shareKey, gmail: gmail, password: password })
      .then(function (res) {
        hideLoading();
        document.getElementById('btnLogin').disabled = false;
        if (res.success) {
          APP.token = res.token;
          APP.shareKey = shareKey; // ç™ºè¡Œã‚­ãƒ¼ã‚’ä¿æŒ
          if (res.isFirstLogin) {
            setupPresent(res.accountInfo);
            navigateTo('present');
          } else {
            navigateTo('comingSoon'); // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ç›´æ¥Coming Soonã¸
          }
        } else {
          showToast(res.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      })
      .catch(function (err) {
        hideLoading();
        document.getElementById('btnLogin').disabled = false;
        showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
      });
  }

  // ============================================================
  // åˆå›ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ
  // ============================================================
  function setupPresent(accountInfo) {
    // å­˜åœ¨ã—ãªã„è¦ç´ (presentName)ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢
    document.getElementById('presentBannerWrap').classList.add('hidden');
    document.getElementById('presentIconWrap').classList.add('hidden');
    document.getElementById('presentAccountName').textContent = accountInfo.accountName || '';
    document.getElementById('presentId').textContent = '';
    document.getElementById('presentBio').textContent = '';
    document.getElementById('presentInviteCode').textContent = '';
  }

  function loadPresent() {
    if (!APP.shareKey) {
      console.error('shareKey ãŒæœªè¨­å®šã®ãŸã‚ Starter Kit ã‚’å–å¾—ã§ãã¾ã›ã‚“');
      return;
    }

    callApi('apiGetStartupItems', { shareKey: APP.shareKey })
      .then(function (res) {
        console.log('StartupItems res:', res);
        if (!res || !res.success) {
          console.error('apiGetStartupItems ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        var bannerUrl = res.bannerUrl || '';
        var iconUrl = res.iconUrl || '';
        var x = (res.xId || '').trim();
        if (x && x[0] !== '@') x = '@' + x;

        document.getElementById('presentAccountName').textContent = res.accountName || '';
        document.getElementById('presentId').textContent = x;
        document.getElementById('presentBio').textContent = res.bio || '';
        document.getElementById('presentInviteCode').textContent = res.inviteCode || '';

        if (bannerUrl) {
          document.getElementById('presentBannerImage').src = bannerUrl;
          document.getElementById('presentBannerWrap').classList.remove('hidden');
        }
        if (iconUrl) {
          document.getElementById('presentIconImage').src = iconUrl;
          document.getElementById('presentIconWrap').classList.remove('hidden');
        }

        // å„è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼ï¼ˆæŒ‡ç¤ºã«åŸºã¥ãã€Œåå¿œã€ã®æ”¹å–„ï¼‰
        var setCopyClick = function (id, text, label) {
          var el = document.getElementById(id);
          if (!el) return;
          el.style.cursor = 'pointer';
          el.title = label + 'ã‚’ã‚³ãƒ”ãƒ¼';
          el.onclick = function () {
            if (!text) return;
            copyToClipboard(text);
          };
        };

        setCopyClick('presentAccountName', res.accountName, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå');
        setCopyClick('presentId', x, 'ID');
        setCopyClick('presentBio', res.bio, 'ãƒã‚¤ã‚ª');
        setCopyClick('presentInviteCode', res.inviteCode, 'æ‹›å¾…ã‚³ãƒ¼ãƒ‰');
        setCopyClick('presentBannerWrap', bannerUrl, 'ãƒãƒŠãƒ¼URL');
        setCopyClick('presentIconWrap', iconUrl, 'ã‚¢ã‚¤ã‚³ãƒ³URL');

      })
      .catch(function (err) {
        console.error('apiGetStartupItems error:', err);
      });
  }

  function handleCompleteFirstLogin() {
    showLoading('æº–å‚™ä¸­...');
    callApi('apiCompleteFirstLogin', { token: APP.token })
      .then(function (res) {
        hideLoading();
        navigateTo('comingSoon'); // Coming Soonã¸é·ç§»
      })
      .catch(function () {
        hideLoading();
        navigateTo('comingSoon');
      });
  }

  // ============================================================
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  // ============================================================
  function loadDashboard() {
    if (!APP.token) return;
    callApi('apiGetDashboard', { token: APP.token })
      .then(function (res) {
        if (!res.success) return;
        document.getElementById('dashUserName').textContent = (res.accountName || res.userName || '') + ' â€” Command Deck';
        document.getElementById('dashTodayCount').textContent = res.todayCount;
        document.getElementById('dashDailyMax').textContent = res.dailyMax;
        document.getElementById('dashTotalCount').textContent = res.totalCount;

        var banner = document.getElementById('dashStrategyBanner');
        banner.textContent = 'ä»Šæ—¥ã¯' + res.dayName + 'æ›œæ—¥ã€‚' + res.strategy + ' ã§ä¼¸ã°ã™æ—¥ã§ã™ã€‚';
        banner.className = 'strategy-banner ' + res.strategy;

        APP.strategy = res.strategy;
        APP.strategyColor = res.strategyColor;
      })
      .catch(function (err) {
        console.error('dashboard error:', err);
      });
  }

  // ============================================================
  // æŠ•ç¨¿ç”Ÿæˆç”»é¢
  // ============================================================
  function loadStudio() {
    if (!APP.token) return;
    callApi('apiGetStrategyGuide', { token: APP.token })
      .then(function (res) {
        if (!res.success) return;
        var banner = document.getElementById('studioStrategyBanner');
        banner.textContent = 'ä»Šæ—¥ã¯' + res.dayName + 'æ›œæ—¥ã€‚' + res.strategy + ' ã§ä¼¸ã°ã™æ—¥ã§ã™ã€‚';
        banner.className = 'strategy-banner ' + res.strategy;
        APP.strategy = res.strategy;

        // æˆ¦ç•¥ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
        renderStrategyGuide(res.guide);

        // æ®‹ã‚Šå›æ•°å–å¾— (DashboardçµŒç”±)
        return callApi('apiGetDashboard', { token: APP.token });
      })
      .then(function (dashRes) {
        if (dashRes && dashRes.success) {
          var remaining = dashRes.dailyMax - dashRes.todayCount;
          document.getElementById('studioRemaining').textContent = Math.max(0, remaining);
        }
      })
      .catch(function (err) {
        console.error('studio init error:', err);
      });

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    document.getElementById('inputTheme').oninput = function () {
      document.getElementById('themeCount').textContent = this.value.length;
    };
    document.getElementById('inputTarget').oninput = function () {
      document.getElementById('targetCount').textContent = this.value.length;
    };
  }

  function handleGenerate() {
    var theme = document.getElementById('inputTheme').value.trim();
    var target = document.getElementById('inputTarget').value.trim();

    if (!theme) { showToast('ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return; }
    if (!target) { showToast('ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return; }

    showLoading('AIç”Ÿæˆä¸­...');
    document.getElementById('btnGenerate').disabled = true;

    callApi('apiGeneratePosts', { token: APP.token, theme: theme, target: target, params: null })
      .then(function (res) {
        hideLoading();
        document.getElementById('btnGenerate').disabled = false;
        if (res.success) {
          APP.posts = res.posts;
          APP.templateData = res.templateInfo;
          renderGenerationResult(res);
          showToast('ç”Ÿæˆå®Œäº†ï¼', 'success');
        } else {
          showToast(res.message, 'error');
        }
      })
      .catch(function (err) {
        hideLoading();
        document.getElementById('btnGenerate').disabled = false;
        showToast('ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
      });
  }

  function renderGenerationResult(res) {
    // æ®‹ã‚Šå›æ•°æ›´æ–°
    var remaining = res.dailyMax - res.todayCount;
    document.getElementById('studioRemaining').textContent = Math.max(0, remaining);

    // ãƒ†ãƒ³ãƒ—ãƒ¬ç©´åŸ‹ã‚
    renderTemplateSlots(res.strategy, res.templateInfo);
    document.getElementById('templateSection').classList.remove('hidden');

    // A/BæŠ•ç¨¿ã‚«ãƒ¼ãƒ‰
    var cardsHtml = '';
    for (var i = 0; i < res.posts.length; i++) {
      var p = res.posts[i];
      var cl = p.checklistResult;
      cardsHtml += '<div class="post-card">';
      cardsHtml += '<span class="variant-badge ' + p.abVariant + '">' + p.abVariant + ' â€” ' + (res.abRules ? res.abRules[p.abVariant] : '') + '</span>';
      cardsHtml += '<div class="post-text">' + escapeHtml(p.text) + '</div>';
      cardsHtml += '<div class="char-count' + (p.text.length > 140 ? ' over' : '') + '">' + p.text.length + 'æ–‡å­—</div>';
      if (!cl.passed) {
        cardsHtml += '<div class="checklist-warn">';
        for (var r = 0; r < cl.reasons.length; r++) {
          cardsHtml += 'âš ï¸ ' + escapeHtml(cl.reasons[r]) + '<br>';
        }
        cardsHtml += '</div>';
      }
      cardsHtml += '<button class="btn btn-copy btn-sm mt-1" onclick="copyPostText(' + i + ')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>';
      cardsHtml += '</div>';
    }
    document.getElementById('postCards').innerHTML = cardsHtml;

    // ãƒ¡ã‚¤ãƒ³æŠ•ç¨¿ç·¨é›†æ¬„ã«AæŠ•ç¨¿ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('mainPostEdit').value = res.posts[0] ? res.posts[0].text : '';
    updateMainPostCounter();

    // ãƒ¡ã‚¤ãƒ³æŠ•ç¨¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    document.getElementById('mainPostEdit').oninput = updateMainPostCounter;

    // ãƒªãƒ—ãƒ©ã‚¤åˆæœŸåŒ–
    document.getElementById('replyBlocks').innerHTML = '';
    APP.replyCount = 0;
    // EMPATHY/PROOFã¯åˆæ‰‹ãƒªãƒ—è‡ªå‹•æŒ¿å…¥
    if (res.strategy === 'EMPATHY' || res.strategy === 'PROOF') {
      addReplyBlock('ãƒªãƒ—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼å®Ÿã¯ã“ã®è©±ã«ã¯ç¶šããŒã‚ã£ã¦â€¦');
    } else {
      addReplyBlock('');
    }

    document.getElementById('resultSection').classList.remove('hidden');
  }

  function updateMainPostCounter() {
    var text = document.getElementById('mainPostEdit').value;
    var counter = document.getElementById('mainPostCounter');
    counter.textContent = text.length + '/140';
    counter.className = 'char-counter';
    if (text.length > 140) counter.className += ' over';
    else if (text.length > 130) counter.className += ' warn';
  }

  // ============================================================
  // ãƒ†ãƒ³ãƒ—ãƒ¬ç©´åŸ‹ã‚
  // ============================================================
  function renderTemplateSlots(strategy, templateInfo) {
    var templates = {
      PARADOX: [
        { label: 'å¸¸è­˜', placeholder: 'ã¿ã‚“ãªãŒä¿¡ã˜ã¦ã„ã‚‹å‰æ', hints: ['è‡ªåˆ†ã‚‚æ˜”ã¯ä¿¡ã˜ã¦ã„ãŸã“ã¨', 'SNSã§ã‚ˆãè¦‹ã‚‹è¨€è‘‰', '"æ™®é€šã¯ã“ã†"ã¨æ€ã‚ã‚Œã¦ã„ã‚‹ã“ã¨'] },
        { label: 'ä½“é¨“', placeholder: 'ä¸€ç•ªã—ã‚“ã©ã‹ã£ãŸå…·ä½“å ´é¢', hints: ['å¤±æ•—ã—ãŸæ•°å­—ãƒ»æœŸé–“', 'æ„Ÿæƒ…ãŒå‹•ã„ãŸç¬é–“', 'èª°ã«ã‚‚è¨€ã£ã¦ãªã„ä½“é¨“'] },
        { label: 'å•ã„', placeholder: 'è»½ã„å•ã„ã‹ã‘', hints: ['ã€Œã‚ãªãŸã¯ã©ã†æ€ã†ï¼Ÿã€', 'ã€Œæœ¬å½“ã«ãã†ï¼Ÿã€', 'è€ƒãˆã•ã›ã‚‹ä¸€è¨€'] }
      ],
      EMPATHY: [
        { label: 'æ‚©ã¿', placeholder: 'ä»Šã¤ã‚‰ã„çŠ¶æ³', hints: ['æˆ‘æ…¢ã—ã¦ã„ãŸã“ã¨ã¯ï¼Ÿ', 'è¨€ãˆãªã‹ã£ãŸæœ¬éŸ³ã¯ï¼Ÿ', 'é€ƒã’ãŸã‹ã£ãŸç¬é–“ã¯ï¼Ÿ'] },
        { label: 'éå»ä½“é¨“', placeholder: 'è‡ªåˆ†ã‚‚åŒã˜ã ã£ãŸè©±', hints: ['ã„ã¤ã€ã©ã“ã§ï¼Ÿ', 'ä½•ãŒä¸€ç•ªãã¤ã‹ã£ãŸï¼Ÿ', 'ä»Šãªã‚‰å½“æ™‚ã®è‡ªåˆ†ã«ä½•ã¨è¨€ã†ï¼Ÿ'] },
        { label: 'å‘¼ã³ã‹ã‘', placeholder: 'å…±æœ‰ãƒ»èª˜ã„', hints: ['ã€Œä½“é¨“æ•™ãˆã¦ã€', 'ã€ŒåŒã˜äººã„ãªã„ï¼Ÿã€', 'è¿”ä¿¡ã—ã‚„ã™ã„å•ã„ã‹ã‘'] }
      ],
      PROOF: [
        { label: 'æ•°å­—æˆæœ', placeholder: 'å…·ä½“çš„ãªæ•°å­—çµæœ', hints: ['æœŸé–“ã¨é‡‘é¡', 'Beforeâ†’After', 'æ•°å­—ã§è¨€ã†ã¨ä½•ãŒå¤‰ã‚ã£ãŸï¼Ÿ'] },
        { label: 'è¡Œå‹•â‘ ', placeholder: 'å…·ä½“è¡Œå‹•1ã¤ç›®', hints: ['ä¸€ç•ªåŠ¹æœãŒã‚ã£ãŸã“ã¨', 'æ¯æ—¥ã‚„ã£ãŸã“ã¨', '1ã¤ã«çµã‚‹ãªã‚‰ï¼Ÿ'] },
        { label: 'è¡Œå‹•â‘¡', placeholder: 'å…·ä½“è¡Œå‹•2ã¤ç›®', hints: ['è£œåŠ©çš„ã«ã‚„ã£ãŸã“ã¨', 'é€†ã«ã€Œã‚„ã‚‰ãªãã¦ã„ã„ã€ã¨æ€ã£ãŸã“ã¨', 'ã‚³ã‚¹ãƒˆã‚¼ãƒ­ã§ã§ããŸã“ã¨'] }
      ]
    };

    var slots = templates[strategy] || templates.PARADOX;
    var html = '';
    for (var i = 0; i < slots.length; i++) {
      var s = slots[i];
      html += '<div class="template-slot">';
      html += '<div class="slot-label">ã€' + s.label + 'ã€‘</div>';
      html += '<input type="text" class="slot-input" id="slot_' + i + '" placeholder="' + s.placeholder + '">';
      html += '<div class="hint-popup"><ul>';
      for (var h = 0; h < s.hints.length; h++) {
        html += '<li>' + s.hints[h] + '</li>';
      }
      html += '</ul></div></div>';
    }
    document.getElementById('templateSlots').innerHTML = html;
  }

  function reflectTemplateToMain() {
    var slots = document.querySelectorAll('.slot-input');
    var parts = [];
    for (var i = 0; i < slots.length; i++) {
      var v = slots[i].value.trim();
      if (v) parts.push(v);
    }
    if (parts.length > 0) {
      document.getElementById('mainPostEdit').value = parts.join('ã€‚') + 'ã€‚';
      updateMainPostCounter();
      showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚‰åæ˜ ã—ã¾ã—ãŸ', 'info');
    } else {
      showToast('ç©´åŸ‹ã‚ã«å…¥åŠ›ã—ã¦ã‹ã‚‰åæ˜ ã—ã¦ãã ã•ã„', 'error');
    }
  }

  // ============================================================
  // ãƒªãƒ—ãƒ©ã‚¤ç®¡ç†
  // ============================================================
  function addReplyBlock(initialText) {
    APP.replyCount++;
    var idx = APP.replyCount;
    var block = document.createElement('div');
    block.className = 'reply-block';
    block.id = 'reply_' + idx;
    block.innerHTML = '<div class="reply-header">' +
      '<span class="reply-label">ãƒªãƒ—' + idx + '</span>' +
      '<button class="btn-remove-reply" onclick="removeReply(' + idx + ')">Ã—</button>' +
      '</div>' +
      '<textarea class="input-field" id="replyText_' + idx + '" rows="3" placeholder="ãƒªãƒ—ãƒ©ã‚¤ã‚’å…¥åŠ›..." oninput="updateReplyCounter(' + idx + ')">' + (initialText || '') + '</textarea>' +
      '<div class="char-counter" id="replyCounter_' + idx + '">' + (initialText ? initialText.length : 0) + '/140</div>';
    document.getElementById('replyBlocks').appendChild(block);
  }

  function removeReply(idx) {
    var el = document.getElementById('reply_' + idx);
    if (el) el.remove();
  }

  function updateReplyCounter(idx) {
    var text = document.getElementById('replyText_' + idx).value;
    var counter = document.getElementById('replyCounter_' + idx);
    counter.textContent = text.length + '/140';
    counter.className = 'char-counter';
    if (text.length > 140) counter.className += ' over';
    else if (text.length > 130) counter.className += ' warn';
  }

  // ============================================================
  // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
  // ============================================================
  function copyPostText(idx) {
    if (APP.posts && APP.posts[idx]) {
      copyToClipboard(APP.posts[idx].text);
    }
  }

  function copyMainPost() {
    var text = document.getElementById('mainPostEdit').value;
    copyToClipboard(text);
  }

  function copyReply(idx) {
    var el = document.getElementById('replyText_' + (idx + 1));
    if (el) copyToClipboard(el.value);
  }

  function copyAllReplies() {
    var blocks = document.querySelectorAll('[id^="replyText_"]');
    var texts = [];
    for (var i = 0; i < blocks.length; i++) {
      if (blocks[i].value.trim()) texts.push(blocks[i].value.trim());
    }
    if (texts.length > 0) {
      copyToClipboard(texts.join('\n---\n'));
    }
  }

  function copyToClipboard(text) {
    if (!text) { showToast('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); return; }

    // æ–°ã—ã„Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function () {
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
      }).catch(function () {
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text) {
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand('copy');
      showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
    } catch (e) {
      showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
    document.body.removeChild(ta);
  }

  // ============================================================
  // æˆ¦ç•¥ã‚¬ã‚¤ãƒ‰
  // ============================================================
  function renderStrategyGuide(guide) {
    if (!guide) return;
    var html = '<h4>ğŸ“Œ ' + APP.strategy + ' æˆ¦ç•¥ã‚¬ã‚¤ãƒ‰</h4>';
    html += '<div class="guide-item"><span class="emoji">ğŸ¯</span>KPIç›®å®‰ï¼š' + guide.kpi + '</div>';
    html += '<div class="guide-item"><span class="emoji">ğŸ“</span>æ§‹é€ ï¼š' + guide.structure + '</div>';
    html += '<div class="guide-item"><span class="emoji">â±</span>1åˆ†ãƒ«ãƒ¼ãƒãƒ³ï¼š' + guide.routine + '</div>';
    html += '<h4 class="mt-2" style="color:#FC8181;">ğŸš« ã‚„ã‚‹ãª3ã¤</h4>';
    for (var i = 0; i < guide.dontDo.length; i++) {
      html += '<div class="guide-item dont"><span class="emoji">âŒ</span>' + guide.dontDo[i] + '</div>';
    }
    html += '<div class="guide-item mt-1"><span class="emoji">ğŸ”„</span>A/Bå·®åˆ†ï¼šA=' + guide.abDiff.A + ' / B=' + guide.abDiff.B + '</div>';
    document.getElementById('strategyGuidePanel').innerHTML = html;
  }

  // ============================================================
  // è¾æ›¸
  // ============================================================
  function loadDictionary() {
    if (!APP.token) return;
    showLoading('è¾æ›¸èª­ã¿è¾¼ã¿ä¸­...');
    callApi('apiGetDictionary', { token: APP.token })
      .then(function (res) {
        hideLoading();
        if (!res.success) return;
        var d = res.dictionary;
        document.getElementById('dictFacts').value = d.facts || '';
        document.getElementById('dictNumbers').value = d.numbers || '';
        document.getElementById('dictEfforts').value = d.efforts || '';
        document.getElementById('dictEmotions').value = d.emotions || '';
        document.getElementById('dictAesthetics').value = d.aesthetics || '';
        document.getElementById('dictPunchline').value = d.punchline || '';
      })
      .catch(function () {
        hideLoading();
      });
  }

  function handleSaveDictionary() {
    showLoading('ä¿å­˜ä¸­...');
    var updates = {
      facts: document.getElementById('dictFacts').value.trim(),
      numbers: document.getElementById('dictNumbers').value.trim(),
      efforts: document.getElementById('dictEfforts').value.trim(),
      emotions: document.getElementById('dictEmotions').value.trim(),
      aesthetics: document.getElementById('dictAesthetics').value.trim(),
      punchline: document.getElementById('dictPunchline').value.trim()
    };

    callApi('apiUpdateDictionary', { token: APP.token, updates: updates })
      .then(function (res) {
        hideLoading();
        if (res.success) {
          showToast('è¾æ›¸ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
        } else {
          showToast(res.message, 'error');
        }
      })
      .catch(function () {
        hideLoading();
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      });
  }

  // ============================================================
  // Growth Console
  // ============================================================
  function loadGrowth() {
    if (!APP.token) return;
    callApi('apiGetDashboard', { token: APP.token })
      .then(function (res) {
        if (!res.success) return;
        document.getElementById('growthTotal').textContent = res.totalCount;
        document.getElementById('growthToday').textContent = res.todayCount;
      })
      .catch(function (err) {
        console.error('growth load error:', err);
      });
  }

  // ============================================================
  // ãƒ©ãƒ³ãƒ€ãƒ ãƒ’ãƒ³ãƒˆ
  // ============================================================
  var RANDOM_HINTS = [
    'ä¸€ç•ªæœ€åˆã«è«¦ã‚ã‹ã‘ãŸç¬é–“ã¯ï¼Ÿ',
    'ãã‚Œã§ã‚‚ç¶šã‘ãŸç†ç”±ã¯ï¼Ÿ',
    'èª°ã«ã‚‚è¨€ã£ã¦ã„ãªã„å¤±æ•—ã¯ï¼Ÿ',
    'ä¸€ç•ªå¬‰ã—ã‹ã£ãŸåå¿œã¯ï¼Ÿ',
    'ã‚‚ã†ä¸€åº¦ã‚„ã‚‹ãªã‚‰ä½•ã‚’å¤‰ãˆã‚‹ï¼Ÿ',
    'å§‹ã‚ãŸæ™‚ã€å‘¨ã‚Šã«ä½•ã¨è¨€ã‚ã‚ŒãŸï¼Ÿ',
    'ä¸€ç•ªãŠé‡‘ã‚’ã‹ã‘ãŸã“ã¨ã¯ï¼Ÿ',
    'å¤œä¸­ã«è€ƒãˆã¦ã—ã¾ã†ã“ã¨ã¯ï¼Ÿ',
    'æˆåŠŸã¨å¤±æ•—ã®åˆ†ã‹ã‚Œç›®ã¯ä½•ã ã£ãŸï¼Ÿ',
    '3ãƒ¶æœˆå‰ã®è‡ªåˆ†ã«ä¼ãˆãŸã„ã“ã¨ã¯ï¼Ÿ',
    'ä¸€ç•ªæ™‚é–“ã‚’ç„¡é§„ã«ã—ãŸã“ã¨ã¯ï¼Ÿ',
    'ã€Œã‚„ã‚ã‚ˆã†ã‹ãªã€ã¨æ€ã£ãŸå›æ•°ã¯ï¼Ÿ',
    'æ„å¤–ã¨åŠ¹æœãŒã‚ã£ãŸå°ã•ãªå·¥å¤«ã¯ï¼Ÿ'
  ];

  function showRandomHint() {
    var hint = RANDOM_HINTS[Math.floor(Math.random() * RANDOM_HINTS.length)];
    document.getElementById('randomHint').textContent = 'ğŸ’­ ' + hint;
  }

  // ============================================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // ============================================================
  function showLoading(text) {
    document.getElementById('loadingText').textContent = text || 'èª­ã¿è¾¼ã¿ä¸­...';
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  function showToast(message, type) {
    var toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + (type || 'info');
    toast.classList.remove('hidden');
    setTimeout(function () {
      toast.classList.add('hidden');
    }, 3000);
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>